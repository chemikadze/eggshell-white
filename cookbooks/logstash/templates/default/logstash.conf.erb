input {
  tcp {
    format => "json"
    mode => "server"
    host => "0.0.0.0"
    port => 8514
    ssl_enable => true
    ssl_cert => "/var/lib/logstash/server.pem"
    ssl_key => "/var/lib/logstash/server.key"
    ssl_verify => false
    type => "nxlog"
  }
}
filter {
  date {
      match => [ "EventReceivedTime", "YYYY-MM-dd HH:mm:ss" ]
  }

  grok {
      type => "nxlog"

      # v1 cobalt-52aab45be4b0ef4e9b9e0a9b.applications.52d4de58e4b08ec56d58a714.workflow/jobid.stepid.stepname/filename.txt
      # v2 52d4de58e4b08ec56d58a714/jobid.stepid.stepname/filename.txt
      match => [ "FileName", "(cobalt-%{BASE16NUM:appId}\.applications\.%{BASE16NUM:instId}\.?%{DATA:componentId}|%{BASE16NUM:instId})/(%{DATA:jobId}\.%{DATA:stepId}\.%{DATA:stepname}|%{DATA})/%{GREEDYDATA:filename}" ]
  }

  mutate {
    type => "nxlog"
    add_tag => "unprocessed"
  }

  grok { # chef logs
      type => "nxlog" # TIMESTAMP_ISO8601
                      # [2013-12-11T18:21:19+00:00] INFO: Setting the run_list to ["recipe[chef-solo-extension]", "recipe[nxlog]"] from JSON
      tags => [ "unprocessed" ]
      remove_tag => [ "unprocessed" ]
      match => [ "Message", "\[[^\]]+\] %{LOGLEVEL:Severity}: %{GREEDYDATA:MessageTxt}" ]
  }
  grok { # chef client warnings
      type => "nxlog"
      tags => [ "unprocessed" ]
      remove_tag => [ "unprocessed" ]
      match => [ "Message", "[/\w_%!$@:.,-]+:%{NUMBER}: %{DATA:Severity}: %{GREEDYDATA:MessageTxt}" ]
  }

  grok { # other messages from stderr
    type => "nxlog"
    tags => [ "unprocessed" ]
    remove_tag => [ "unprocessed" ]
    match => [ "Stream", "stderr" ]
    add_field => [ "Severity", "ERROR" ]
    add_field => [ "MessageTxt", "%{Message}" ]
  }

  grok { # other messages stdout
    type => "nxlog"
    tags => [ "unprocessed" ]
    remove_tag => [ "unprocessed" ]
    match => [ "Stream", "stdout" ]
    add_field => [ "Severity", "INFO" ]
    add_field => [ "MessageTxt", "%{Message}" ]
  }

  mutate { # messages from custom locations
    type => "nxlog"
    tags => [ "unprocessed" ]
    remove_tag => [ "unprocessed" ]
    add_field => [ "Severity", "INFO" ] # TODO: parse most common formats
    add_field => [ "filename", "%{FileName}" ]
    add_field => [ "MessageTxt", "%{Message}" ]
  }

  mutate {
      type => "nxlog"
      replace => [ "@severity", "%{Severity}" ]
      replace => [ "@message", "%{MessageTxt}" ]
      replace => [ "@raw", "%{Message}" ]
  }

  mutate {
      type => "nxlog"
      remove => [ "Message", "MessageTxt", "Severity", "SourceModuleType", "SourceModuleName", "EventReceivedTime", "FileName", "@source_path", "@source" ]
  }

}
output {
  stdout { debug => true }
  elasticsearch {
      index => "logstash-%{+YYYY.MM.dd.HH}"
      embedded => true
  }
}
